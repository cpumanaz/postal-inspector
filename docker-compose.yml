networks:
  mail:
    driver: bridge

volumes:
  clamav-data:

# SECURITY NOTES:
# - Docker's default seccomp profile is applied to all containers (blocks ~44 dangerous syscalls)
# - All containers drop ALL capabilities and use no-new-privileges
# - Resource limits prevent DoS via memory/CPU exhaustion
# - Passwords configured via .env file (standard Docker Compose pattern)

services:
  # ===========================================
  # IMAP Server (Dovecot)
  # ===========================================
  imap:
    build: ./services/imap
    restart: unless-stopped
    hostname: mail
    ports:
      # SECURITY: Only expose TLS port, not plaintext
      - "${IMAPS_PORT:-993}:993"
    # SECURITY: Resource limits
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
          pids: 100
    volumes:
      - ./data/maildir:/var/mail:delegated
      - ./services/imap/conf.d:/etc/dovecot/conf.d:ro
      - ./certs/fullchain.pem:/etc/ssl/certs/fullchain.pem:ro
      - ./certs/privkey.pem:/etc/ssl/private/privkey.pem:ro
    env_file:
      - .env
    networks:
      - mail
    healthcheck:
      test: ["CMD", "doveadm", "service", "status"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # Mail Processor (Python - replaces mail-fetch + ai-scanner)
  # ===========================================
  mail-processor:
    build:
      context: .
      dockerfile: services/python-scanner/Dockerfile
    restart: unless-stopped
    depends_on:
      imap:
        condition: service_healthy
    user: "5000:5000"
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
          pids: 50
    volumes:
      - ./data/maildir:/var/mail:rw
      - ./logs/mail-processor:/app/logs:rw
    env_file:
      - .env
    environment:
      - LMTP_HOST=imap
      - LMTP_PORT=24
    networks:
      - mail
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # Virus Scanner (ClamAV)
  # ===========================================
  antivirus:
    image: clamav/clamav:1.4
    restart: unless-stopped
    # SECURITY: Resource limits (ClamAV needs more RAM for virus signatures)
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
          pids: 100
    volumes:
      - clamav-data:/var/lib/clamav
    env_file:
      - .env
    networks:
      - mail
    healthcheck:
      test: ["CMD", "clamdscan", "--ping", "3"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 120s

  # ===========================================
  # Daily Briefing (Python)
  # ===========================================
  daily-briefing:
    build:
      context: .
      dockerfile: services/python-briefing/Dockerfile
    restart: unless-stopped
    depends_on:
      imap:
        condition: service_healthy
    user: "5000:5000"
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
          pids: 50
    volumes:
      - ./data/maildir:/var/mail:ro
      - ./logs/daily-briefing:/app/logs:rw
    env_file:
      - .env
    environment:
      - LMTP_HOST=imap
      - LMTP_PORT=24
    networks:
      - mail
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
