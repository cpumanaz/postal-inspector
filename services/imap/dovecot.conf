# Dovecot configuration for mail-stack

# Protocols
protocols = imap lmtp

# Listen on all interfaces
listen = *

# Logging
log_path = /dev/stderr
info_log_path = /dev/stdout

# Mail location - Maildir format
mail_location = maildir:/var/mail/%u

# Authentication
auth_mechanisms = plain login

# Password database - use passwd-file
passdb {
  driver = passwd-file
  args = /etc/dovecot/users
}

# User database
userdb {
  driver = passwd-file
  args = /etc/dovecot/users
  default_fields = uid=vmail gid=vmail home=/var/mail/%u
}

# SSL/TLS
ssl = yes
ssl_cert = </etc/ssl/certs/fullchain.pem
ssl_key = </etc/ssl/private/privkey.pem
ssl_min_protocol = TLSv1.2

# Allow plaintext auth only over SSL
disable_plaintext_auth = yes

# IMAP settings
protocol imap {
  mail_max_userip_connections = 20
}

# LMTP for local delivery with Sieve filtering
protocol lmtp {
  mail_plugins = $mail_plugins sieve
}

service lmtp {
  inet_listener lmtp {
    address = 0.0.0.0
    port = 24
  }
}

# Sieve plugin configuration
plugin {
  sieve = /var/mail/%u/.dovecot.sieve
  sieve_default = /etc/dovecot/sieve/default.sieve
  sieve_global_dir = /etc/dovecot/sieve/
}

# Namespace
namespace inbox {
  inbox = yes
  separator = /

  mailbox Drafts {
    auto = subscribe
    special_use = \Drafts
  }
  mailbox Sent {
    auto = subscribe
    special_use = \Sent
  }
  mailbox Trash {
    auto = subscribe
    special_use = \Trash
  }
  mailbox Junk {
    auto = subscribe
    special_use = \Junk
  }
  # AI Scanner folder
  mailbox Quarantine {
    auto = subscribe
  }
}

# Service configuration
service imap-login {
  inet_listener imap {
    port = 143
  }
  inet_listener imaps {
    port = 993
    ssl = yes
  }
}

service auth {
  # SECURITY: Restrict auth socket access
  unix_listener auth-userdb {
    mode = 0600
    user = vmail
    group = vmail
  }
}
